<!doctype html>
<html>
<head> 
  <script src="src/main.ts"></script>
  
  <style>
    .ast, .ast ul, .ast li {
      position: relative;
      vertical-align: top;
    }
    .ast ul {
      list-style-type: none;
      list-style-position: inside;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .ast ul li {
      list-style-type: none;
      list-style-position: inside;
      margin: 0.1em;
      padding: 0;
    }
    .argument, .operator {
      display: inline-block; /* flex */
    }
    .operator {
        text-align: center;
    }
    .word {
      font-family: sans-serif;
      font-size: 0.75em;
      width: 100%;   
      height: 100%;
      text-align: center;
      overflow: hidden;
      text-shadow: 0px 0px 4px white;
      margin: auto;
      border: 1px solid #ccc;
      display: block; /* inline-block */
      border-radius: 10px;
      padding: 0.1em;
      color: #fff;
      background-color: #222;
    }
  </style>
</head>

<script>    
  function ep (prog) {
      return evaluate(parse(prog), {});
  }

  function execute_and_visualise() {
    var to_parse = document.getElementById('console-input').value;
    var parsed = parse(to_parse);
    var evaluated = evaluate(parsed, {});
    document.getElementById('ast-visualisation').innerHTML = visualise(parsed, {}, '0');
    ep('log\'[' + evaluated + '\n<hr style=\'border: none; border-top: 1px solid #ff8888;\' />' + ']');
  }
  
  function drawLine(type, x, y, length) {
    var line = document.createElement("div"),
        borderSide = type === "vertical" ? "left" : "top",
        wh = type === "vertical" ? ["width", "height"] : ["height", "width"],
        styleCss = "border-" + borderSide + ": 1px solid blue; position: absolute; top: "
                    + y + "px; left: "
                    + x + "px; " + wh[0] + ": 0px; " + wh[1] + ": " + length + "px";
    
    line.style = styleCss;
    document.body.appendChild(line);
  }
  
  window.addEventListener("load", function () {
    var consoleInput = document.querySelector("#console-input")
    
    consoleInput.addEventListener("keydown", function (event) {
      var i, words;
      
      console.log(event.which);
      switch (event.which) {
        case 9:
          event.preventDefault();
          consoleInput.value += "\t";
          break;   
        default:
          execute_and_visualise();
          words = document.querySelectorAll(".word");
          
          console.log(words);
          
          for (i = 0; i < words.length; ++i) {
            console.log(i);
             words.item(i).addEventListener("click", function (event) {
              //var styleCss = "color: red; position: relative; bottom: 20px";
              //var styleCss = "color: red; padding-bottom: 20px";
              var styleCss = "background-color: #" + (Math.random()*4+5|0) + (Math.random()*4+5|0) + (Math.random()*4+5|0);

              //drawLine('vertical', event.pageX, event.pageY, 30);
              //drawLine('horizontal', event.pageX, event.pageY, 30);

              event.target.style = styleCss;
            });
            words.item(i).addEventListener("mouseover", function (event) {
              var styleCss = "cursor: pointer;";

              event.target.style = styleCss;
            }); 
          }
          
          break;
      }
    });
  });
</script>

<body style="background-color: #ddd;">
  <div style="width: 49%; float: right; background-color: #dcc;">
    <h2>Visual editor stub</h2>
    <h3>Just a demo. No real interactivity for now. You can click on nodes to make them change colors. Hovering over them resets the color. The code is read left to right, and top to bottom.</h3>
    <pre style="border: 1px solid red; overflow: auto; width: 100%; background-color: #111;">
        <ul id="ast-visualisation" class="ast"></ul>
    </pre>
  </div>
  <div style="width: 49%; float: left;">
    <div style="background-color: #cdc;">
        <h2>Console output</h2>
        <pre id="console-output" style="width: 100%; height: 10em; border: 1px solid red; overflow: auto;"></pre>
    </div>
    <div style="background-color: #ccd;">
        <h2>Text editor</h2>
        <h4>To be replaced by CodeMirror or the like. Edit the source to update the visualisation -- it will be updated as you type.</h4>
        <textarea id="console-input" style="width: 100%; height: 15em; border: 1px solid red;">sequence[
  define[
    five
    number[5]
  ]
  define[
    some-variable
    conditional[
      >[five 3]
      number[3]
      number[4]
    ]
  ]
  $[hello world]
  $[note: the > operator is not implemented yet, so the condition is dummy]
  $[there are true and false values though, so you can make the condition false by replacing >[five 3] by false]
  some-variable]
        </textarea>
        <button onclick="execute_and_visualise();">Execute</button>
    </div>
  </div>
</body>
</html>
